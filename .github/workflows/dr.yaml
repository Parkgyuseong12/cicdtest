name: DR with ArgoCD Setup

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy-dr-stack:
    runs-on: ubuntu-latest
    steps:
      - name: 코드 가져오기
        uses: actions/checkout@v4

      # 1. Azure 로그인
      - name: Azure 로그인
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # 2. Terraform 설치 및 실행 (AKS 생성)
      - name: Terraform 설정
        uses: hashicorp/setup-terraform@v2

      - name: Terraform 실행 (AKS 생성 - 약 10분 소요됨)
        run: |
          terraform init
          terraform apply -auto-approve

      # 3. 생성된 AKS에 접속하기 위한 자격증명 가져오기
      - name: AKS 접속 설정
        uses: azure/aks-set-context@v3
        with:
          resource-group: 'rg-dr-aks-demo'
          cluster-name: 'aks-dr-demo'

      # 4. ArgoCD 설치 (매직!)
      - name: ArgoCD 설치
        run: |
          # ArgoCD 네임스페이스 생성
          kubectl create namespace argocd
          
          # ArgoCD 공식 설치 매니페스트 적용
          kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
          
          echo "ArgoCD 설치 명령이 전송되었습니다. 파드가 뜨는 중입니다..."
